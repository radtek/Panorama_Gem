<script type="text/javascript">

    function toggle_expand(a_id, rec_id, depth, grid_id){
        var anchor = $('#'+a_id);
        //alert(grid_id);
        var grid        = $('#'+grid_id).data('slickgrid');
        var data_view   = grid.getData();
        var grid_data    = data_view.getItems();
        var row = grid_data[rec_id];

        // Ermitteln der Anzahl führender Blanks als Maß für die Hierarchietiefe
        function blank_count(value){
            var i=0;
            while ((value[i] === ' ' || value.charCodeAt(i)===160 /* &nbsp; */ || value[i] === '|') && i<value.length){
                i++;
            }
            return i;
        }

        function toggle_rows(start_rec_id, hide){
            var start_depth = blank_count(row['col0']);
            start_rec_id++;
            while (start_rec_id < grid_data.length && blank_count(grid_data[start_rec_id]['col0']) > start_depth){
                grid_data[start_rec_id]['hidden'] = hide;
                start_rec_id++;
            }

        }


        if (row['collapsed']){
            row['collapsed'] = false;
            anchor.removeClass('expand').addClass('collapse');
            toggle_rows(rec_id, false);
        } else {
            row['collapsed'] = true;
            anchor.removeClass('collapse').addClass('expand');
            toggle_rows(rec_id, true);
        }
        data_view.refresh();                                                    // Ausloesen der erneuten Verarbeitung der Filter-Funktion

    }

    function filter_collapsed_item_rows(item) {
        if (item['hidden'])
            return false;
        return true;
    }

</script>



<%
  @update_area = get_unique_area_id
  @indent_vector    = []

  column_options =
      [
          { caption: "Operation",     data: proc{|rec| list_tree_column_operation(rec, @indent_vector, @plans) }, :no_wrap=>true,                         title: 'Kind of data access', data_title: proc{|rec| "%t:\nOperation = #{rec.operation}\nOptions = #{rec.options}\n\n#{explain_data_access("#{rec.operation} #{rec.options}")}#{"\n\nOther = #{rec.other}" if rec.other }"}},
          {:caption=>"ID",          :data=>proc{|rec| rec.id },  :align=>:right,                    :title=>'ID of operation',             :data_title=>proc{|rec| "%t: Parent_ID=#{rec.parent_id}"} },
          {:caption=>"R.",          :data=>proc{|rec| rec.execorder },  :align=>:right,             :title=>'Execution order of operation',    :data_title=>proc{|rec| "%t: ID=#{rec.id}\nParent_ID=#{rec.parent_id}"} },

          {:caption=>"Operation",             :data=>proc{|rec| rec.operation},                           :title=>'Kind of access'},
          {:caption=>"Options",               :data=>proc{|rec| rec.options},                             :title=>'Access details'},
          {:caption=>"Object_name", :data=>proc{|rec| link_object_description(@update_area, rec.object_owner, rec.object_name) }, :title=>'Object name'},
          {:caption=>"Optimizer",             :data=>proc{|rec| rec.optimizer},                           :title=>'Optimizer mode'},
          {:caption=>"Access",                :data=>proc{|rec| html_escape(rec.access_predicates)},      :title=>'Access criteria'},
          {:caption=>"Filter",                :data=>proc{|rec| html_escape(rec.filter_predicates)},      :title=>'Filter criteria'},
          {:caption=>"Other_Tag",             :data=>proc{|rec| rec.other_tag},                           :title=>"Other_Tag"},
          {:caption=>"Distribution",          :data=>proc{|rec| rec.distribution},                        :title=>"Distribution"},
      ]
%>

<%= gen_slickgrid(@plans, column_options, {
    :max_height => 450,
})
%>

<div id="<%= @update_area %>" style="clear:both; width:100%; "></div>